# üì¨ –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π V2 - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-11-30  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞

---

## üéØ –û–±–∑–æ—Ä

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π V2 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–∞—á–∞–ª–µ –ø–∞—Ä —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é.

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ V2

| –ü–∞—Ä–∞–º–µ—Ç—Ä | V1 (–°—Ç–∞—Ä–∞—è) | V2 (–ù–æ–≤–∞—è) |
|----------|-------------|------------|
| **–¢–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏** | ¬±5 –º–∏–Ω—É—Ç | ¬±10 —Å–µ–∫—É–Ω–¥ |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞** | –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) | –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ) |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è (O(n) –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω) | –í—ã—Å–æ–∫–∞—è (O(1) –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ) |
| **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î** | –í—ã—Å–æ–∫–∞—è (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã) | –ù–∏–∑–∫–∞—è (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å) |
| **Retry –º–µ—Ö–∞–Ω–∏–∑–º** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å (3 –ø–æ–ø—ã—Ç–∫–∏) |
| **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| **–û—Ç–º–µ–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 1: Daily Planner (06:00)                         ‚îÇ
‚îÇ  ‚îú‚îÄ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π             ‚îÇ
‚îÇ  ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ scheduled_notifications              ‚îÇ
‚îÇ  ‚îî‚îÄ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á–∏ –≤ APScheduler                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 2: Notification Executor (—Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è)          ‚îÇ
‚îÇ  ‚îú‚îÄ –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è                   ‚îÇ
‚îÇ  ‚îú‚îÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Bot API         ‚îÇ
‚îÇ  ‚îî‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ –ë–î                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 3: Retry Handler (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)              ‚îÇ
‚îÇ  ‚îú‚îÄ –ò—â–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è                            ‚îÇ
‚îÇ  ‚îú‚îÄ –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ (–º–∞–∫—Å 3)                            ‚îÇ
‚îÇ  ‚îî‚îÄ –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã: 1, 3, 5 –º–∏–Ω—É—Ç                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è: `scheduled_notifications`

```javascript
{
  "id": "uuid",
  "notification_key": "telegram_id_–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞_–≤—Ä–µ–º—è_–¥–∞—Ç–∞",
  "telegram_id": 123456789,
  "date": "2025-11-30",
  "class_info": {
    "discipline": "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑",
    "time": "09:10-10:40",
    "teacher": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
    "auditory": "123",
    "lessonType": "–õ–µ–∫—Ü–∏—è"
  },
  "scheduled_time": ISODate("2025-11-30T09:00:00Z"),
  "notification_time_minutes": 10,
  "status": "pending|sent|failed|cancelled",
  "attempts": 0,
  "last_attempt_at": null,
  "error_message": null,
  "created_at": ISODate("2025-11-30T06:00:00Z"),
  "sent_at": null
}
```

### –ò–Ω–¥–µ–∫—Å—ã

```javascript
// –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
db.scheduled_notifications.createIndex(
  { "notification_key": 1 }, 
  { unique: true }
)

// –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –¥–∞—Ç–µ
db.scheduled_notifications.createIndex(
  { "telegram_id": 1, "date": 1 }
)

// –ü–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ç—É—Å—É
db.scheduled_notifications.createIndex(
  { "status": 1, "date": 1 }
)

// –ü–æ–∏—Å–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
db.scheduled_notifications.createIndex(
  { "scheduled_time": 1 }
)
```

---

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. NotificationSchedulerV2 (`scheduler_v2.py`)

–ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Å –º–µ—Ç–æ–¥–∞–º–∏:

#### –£—Ä–æ–≤–µ–Ω—å 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- `prepare_daily_schedule()` - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ –¥–µ–Ω—å
- `_prepare_user_schedule()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `_create_scheduled_notification()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏ –∑–∞–¥–∞—á–∏

#### –£—Ä–æ–≤–µ–Ω—å 2: –û—Ç–ø—Ä–∞–≤–∫–∞
- `send_notification(notification_id)` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### –£—Ä–æ–≤–µ–Ω—å 3: Retry
- `retry_failed_notifications()` - –ø–æ–∏—Å–∫ –∏ –ø–æ–≤—Ç–æ—Ä –Ω–µ—É–¥–∞—á–Ω—ã—Ö
- `_retry_notification()` - –ø–æ–≤—Ç–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### Maintenance
- `cleanup_old_records()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (> 7 –¥–Ω–µ–π)
- `reset_daily_task_counters()` - —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞–¥–∞—á (00:00)

#### API
- `cancel_notification(id)` - –æ—Ç–º–µ–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `get_notification_stats(date)` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å

---

## üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á

| –ó–∞–¥–∞—á–∞ | –¢—Ä–∏–≥–≥–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|---------|----------|
| `daily_planner` | Cron: 06:00 | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å |
| `initial_planner` | Date: +5 —Å–µ–∫ | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| `retry_handler` | Cron: */2 –º–∏–Ω—É—Ç—ã | –ü–æ–≤—Ç–æ—Ä –Ω–µ—É–¥–∞—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |
| `cleanup_records` | Cron: 02:00 | –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π |
| `reset_daily_tasks` | Cron: 00:00 | –°–±—Ä–æ—Å –¥–Ω–µ–≤–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ |
| `notify_{uuid}` | Date: —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è | –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |

---

## üîå API Endpoints

### GET `/api/notifications/stats`

–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ –¥–µ–Ω—å

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `date` (optional) - –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Å–µ–≥–æ–¥–Ω—è)

**Response:**
```json
{
  "date": "2025-11-30",
  "total": 150,
  "pending": 120,
  "sent": 25,
  "failed": 3,
  "cancelled": 2
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç: `/app/test_scheduler_v2.py`

#### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞:
```bash
cd /app && python test_scheduler_v2.py
```

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ APScheduler
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

#### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ daily planner:
```bash
cd /app && python test_scheduler_v2.py --trigger
```

**–î–µ–π—Å—Ç–≤–∏—è:**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç `prepare_daily_schedule()`
- –°–æ–∑–¥–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API:
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
curl http://localhost:8001/api/notifications/stats

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É
curl http://localhost:8001/api/notifications/stats?date=2025-11-30
```

---

## üöÄ –ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞

### –ó–∞–ø—É—Å–∫

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ backend —á–µ—Ä–µ–∑ `server.py`:

```python
# –í startup_event():
scheduler_v2 = get_scheduler_v2(db)
scheduler_v2.start()
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend
```bash
sudo supervisorctl restart backend
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# –õ–æ–≥–∏ scheduler
tail -f /var/log/supervisor/backend.out.log | grep -i "notification\|scheduler"

# –û—à–∏–±–∫–∏
tail -f /var/log/supervisor/backend.err.log
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–¢–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏** - % —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Ç–µ—á–µ–Ω–∏–µ ¬±30 —Å–µ–∫—É–Ω–¥ –æ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
2. **Success rate** - % —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. **Retry rate** - % —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
4. **–°—Ä–µ–¥–Ω–∏–π attempts** - —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `üìÖ` - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- `üì§` - –û—Ç–ø—Ä–∞–≤–∫–∞
- `‚úÖ` - –£—Å–ø–µ—Ö
- `‚ö†Ô∏è` - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- `‚ùå` - –û—à–∏–±–∫–∞
- `üîÑ` - Retry
- `üßπ` - Cleanup

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å V1

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

1. **–ò–º–ø–æ—Ä—Ç—ã –≤ `server.py`:**
   ```python
   from scheduler import get_scheduler  # V1 (—Ä–µ–∑–µ—Ä–≤)
   from scheduler_v2 import get_scheduler_v2  # V2 (–∞–∫—Ç–∏–≤–Ω–∞)
   ```

2. **Startup event:**
   ```python
   scheduler_v2 = get_scheduler_v2(db)
   scheduler_v2.start()
   # Fallback –Ω–∞ V1 –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
   ```

3. **–ù–æ–≤–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è:**
   - `scheduled_notifications` - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è V2
   - `sent_notifications` - —Å—Ç–∞—Ä–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è V1 (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (`scheduler.py`) —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è
- –ö–æ–ª–ª–µ–∫—Ü–∏—è `sent_notifications` –Ω–µ —É–¥–∞–ª–µ–Ω–∞
- –ü—Ä–∏ –æ—à–∏–±–∫–µ V2 —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ V1

---

## üéõÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑:

1. **–í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ** - `notifications_enabled: bool`
2. **–í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - `notification_time: int` (5-30 –º–∏–Ω—É—Ç –¥–æ –ø–∞—Ä—ã)

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `user_settings`:
```javascript
{
  "telegram_id": 123456789,
  "notifications_enabled": true,
  "notification_time": 10,
  // ...
}
```

---

## üêõ Troubleshooting

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å scheduler:
   ```bash
   python test_scheduler_v2.py
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   tail -f /var/log/supervisor/backend.out.log | grep -i "notification"
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î:
   ```bash
   mongo rudn_schedule
   > db.scheduled_notifications.find().limit(5)
   > db.scheduled_notifications.count({status: "pending"})
   ```

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ daily planner –≤—Ä—É—á–Ω—É—é:
   ```bash
   python test_scheduler_v2.py --trigger
   ```

### Daily planner –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 06:00

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ timezone:
   ```python
   from datetime import datetime
   import pytz
   print(datetime.now(pytz.timezone('Europe/Moscow')))
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–¥–∞—á–∏ –≤ APScheduler:
   ```python
   # –í test_scheduler_v2.py –¥–æ–±–∞–≤—å—Ç–µ:
   jobs = scheduler_v2.scheduler.get_jobs()
   for job in jobs:
       print(f"{job.id}: {job.next_run_time}")
   ```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `notification_key`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

### Retry –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
   ```javascript
   db.scheduled_notifications.find({
     status: "failed",
     attempts: {$lt: 3}
   })
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏:
   ```javascript
   db.scheduled_notifications.find({
     status: "failed",
     last_attempt_at: {$ne: null}
   }).sort({last_attempt_at: -1})
   ```

---

## üìù Changelog

### Version 2.0 (2025-11-30)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å pre-scheduling
- ‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è `scheduled_notifications`
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º (3 –ø–æ–ø—ã—Ç–∫–∏)
- ‚úÖ API –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –¢–æ—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (¬±10 —Å–µ–∫—É–Ω–¥)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_scheduler_v2.py`
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–£–ª—É—á—à–µ–Ω–æ:**
- ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î –Ω–∞ 90%)
- ‚ö° –¢–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ (—Å ¬±5 –º–∏–Ω—É—Ç –¥–æ ¬±10 —Å–µ–∫—É–Ω–¥)
- üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- üîí –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (retry + —Å—Ç–∞—Ç—É—Å—ã)

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:**
- üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å V1
- üíæ –°—Ç–∞—Ä–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è `sent_notifications`
- üõ°Ô∏è Fallback –Ω–∞ V1 –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## üîÆ Roadmap (–±—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è)

### –í–µ—Ä—Å–∏—è 2.1 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- [ ] Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–º–µ–Ω–µ/–ø–µ—Ä–µ–Ω–æ—Å–µ –ø–∞—Ä
- [ ] –£—Ç—Ä–µ–Ω–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- [ ] –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–∞—Ä
- [ ] WebSocket –¥–ª—è real-time —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –í–µ—Ä—Å–∏—è 2.2 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- [ ] –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ì—Ä—É–ø–ø–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–¥–ª—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã —Å—Ä–∞–∑—É)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏ (Google Calendar, Apple Calendar)
- [ ] Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Web App

---

## üë• –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

1. –°–æ–∑–¥–∞–π—Ç–µ –º–µ—Ç–æ–¥ –≤ `NotificationSchedulerV2`:
   ```python
   async def send_custom_notification(self, ...):
       # –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
       pass
   ```

2. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –≤ `start()`:
   ```python
   self.scheduler.add_job(
       self.send_custom_notification,
       trigger=...,
       id='custom_notification',
       name='...'
   )
   ```

3. –°–æ–∑–¥–∞–π—Ç–µ endpoint –≤ `server.py`:
   ```python
   @api_router.post("/notifications/custom")
   async def trigger_custom_notification(...):
       scheduler_v2 = get_scheduler_v2(db)
       await scheduler_v2.send_custom_notification(...)
   ```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ retry

–í `scheduler_v2.py` –∏–∑–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã:
```python
MAX_RETRY_ATTEMPTS = 3  # –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
RETRY_INTERVALS = [1, 3, 5]  # –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤ –º–∏–Ω—É—Ç–∞—Ö
```

---

## üìö –°—Å—ã–ª–∫–∏

- **–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥:** `/app/backend/scheduler_v2.py`
- **–°—Ç–∞—Ä—ã–π –∫–æ–¥ (—Ä–µ–∑–µ—Ä–≤):** `/app/backend/scheduler.py`
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** `/app/backend/notifications.py`
- **–¢–µ—Å—Ç—ã:** `/app/test_scheduler_v2.py`
- **API:** `/app/backend/server.py`
- **–ú–æ–¥–µ–ª–∏:** `/app/backend/models.py`

---

**‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

*–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏.*
